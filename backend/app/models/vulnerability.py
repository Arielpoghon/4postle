from sqlalchemy import Column, String, Text, ForeignKey, Enum, Integer, Float, DateTime, func, JSON
from sqlalchemy.orm import relationship
from datetime import datetime
import enum

from app.models.base import BaseModel

class VulnerabilitySeverity(str, enum.Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"

class VulnerabilityStatus(str, enum.Enum):
    OPEN = "open"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    FALSE_POSITIVE = "false_positive"
    RISK_ACCEPTED = "risk_accepted"

class Vulnerability(BaseModel):
    """Vulnerability model to track security findings."""
    __tablename__ = "vulnerabilities"

    title = Column(String(512), nullable=False)
    description = Column(Text, nullable=False)
    severity = Column(Enum(VulnerabilitySeverity), nullable=False)
    status = Column(Enum(VulnerabilityStatus), default=VulnerabilityStatus.OPEN)
    cvss_score = Column(Float, nullable=True)
    cve_id = Column(String(50), nullable=True, index=True)
    cwe_id = Column(String(50), nullable=True, index=True)
    references = Column(JSON, nullable=True)  # List of reference URLs
    evidence = Column(Text, nullable=True)    # Technical evidence of the vulnerability
    solution = Column(Text, nullable=True)    # Recommended solution or mitigation
    
    # Foreign keys
    target_id = Column(Integer, ForeignKey("targets.id", ondelete="CASCADE"), nullable=False)
    scan_id = Column(Integer, ForeignKey("scans.id", ondelete="CASCADE"), nullable=False)
    
    # Relationships
    target = relationship("Target", back_populates="vulnerabilities")
    scan = relationship("Scan", back_populates="vulnerabilities")
    
    def __repr__(self):
        return f"<Vulnerability {self.title} ({self.severity})>"

    @property
    def is_confirmed(self):
        """Check if the vulnerability has been confirmed as valid."""
        return self.status not in [VulnerabilityStatus.FALSE_POSITIVE, VulnerabilityStatus.RISK_ACCEPTED]

    def to_dict(self):
        """Convert the vulnerability to a dictionary for API responses."""
        return {
            "id": self.id,
            "title": self.title,
            "description": self.description,
            "severity": self.severity.value,
            "status": self.status.value,
            "cvss_score": self.cvss_score,
            "cve_id": self.cve_id,
            "cwe_id": self.cwe_id,
            "references": self.references or [],
            "evidence": self.evidence,
            "solution": self.solution,
            "target_id": self.target_id,
            "scan_id": self.scan_id,
            "created_at": self.created_at.isoformat() if self.created_at else None,
            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
        }
